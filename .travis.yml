---
language: ruby
os: linux
dist: xenial

stages:
- check
- test
- publish

# Default test job matrix.
env:
  matrix:
  - RAILS_VERSION=6.0.6
  - RAILS_VERSION=6.1.4
  - RAILS_VERSION=7.0.4
rvm:
- 2.6.8
- 2.7.5
- &DEV_RUBY_VERSION 3.0.4
install:
# Remove `Gemfile.lock` because we need to install differrent versions of rails
# based on the job matrix.
- rm Gemfile.lock
- bundle install
- bin/rails db:migrate
script:
- BACKTRACE=1 bin/rails test

jobs:
  exclude:
  - rvm: 2.6.8
    env: "RAILS_VERSION=7.0.4"
  include:
  - stage: check
    rvm: *DEV_RUBY_VERSION
    env: []
    install:
    - bundle install
    script:
    - rubocop
  - stage: publish
    if: tag IS present
    rvm: *DEV_RUBY_VERSION
    install: []
    env:
      secure: "Ui5xW3ZMuw1u7DWrSrUiIYBKitEGL9igcyIRkwRjyZNr7dTrcaGh5F5VsHo9MbmcgsyaYGW/YxDJ76V/BWYhK
        duc5e9wNkCbt6U8xYAcNC2kaFm+tfAq0QNNj5v6/vsx11wv1wxInqn782vqtI/Zz02WpCRekyVeBIxZ2a3Vu/BRT5Yjv
        4vCx/4aQs9EVPd07gr4/RwflLMmlqhdVXg6sQUqKXQvWbVwv2HGaAaqmxIHiAYT18rcnyM1YFqQ9x1UKFbNwYZsNgitD
        eXH6c2oocW5Gbvg253YJcyzkNliplp6nThfJLPETKH1FMQIClLX2OoNkxbF7OEeKSjfBAhgJWG6mjlI4Guxu7uPHZvzR
        ct9qSTkGEwyfOPCMLXJYHp8wgd2ddVIJQgC/iiNrTKfyYjXhfl691/jAf2LlhFhTDqSMoWMzWdx3UyLrD109qa3JDBpw
        dPEK/eHbgODG27fHrmMYSfNYmd6D8flkwJQgP82wnCmIT9TrZ3bmDYZdDQA6F8knCz85ZjGjjCfJhljANgPr1/1/aVTy
        gcYxTx65YRVpfFRpSzV1WBhi0MAmHCnAj4515KCcVN8gMPHQ0PATK3BohLieipQ7XwON76V/xMGjlOtF40CVUUMtlxSn
        MIAQNqO5mZ0sYM1Esx3POyyw2gOnkRf0BBzcVw4P9Fb+nI="
    script:
    - "filename=`gem build rest_framework.gemspec 2>&1 | sed -e 's/.*File: \\(.*\\)/\\1/p;d'`"
    - gem push $filename
